# Health-InfraOps Promtail Configuration
# Log collection agent for healthcare infrastructure

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    # For production with authentication:
    # bearer_token_file: /etc/promtail/token
    # tls_config:
    #   ca_file: /etc/promtail/ca.crt

scrape_configs:

# System logs
- job_name: system
  static_configs:
    - targets:
        - localhost
      labels:
        job: system
        environment: production
        __path__: /var/log/*log

# Journald logs
- job_name: journal
  journal:
    json: false
    max_age: 12h
    path: /var/log/journal
    labels:
      job: systemd
      environment: production
  relabel_configs:
    - source_labels: ['__journal__systemd_unit']
      target_label: 'unit'

# Nginx logs
- job_name: nginx
  static_configs:
    - targets:
        - localhost
      labels:
        job: nginx
        component: web-server
        environment: production
        __path__: /var/log/nginx/*log
  pipeline_stages:
    - regex:
        expression: '^(?P<ip>\\S+) \\- \\- \\[(?P<timestamp>[^\\]]+)\\] "(?P<method>\\S+) (?P<path>\\S+) HTTP/(?P<http_version>\\S+)" (?P<status_code>\\d+) (?P<response_size>\\d+) "(?P<referer>[^"]*)" "(?P<user_agent>[^"]*)"'
    - timestamp:
        source: timestamp
        format: '02/Jan/2006:15:04:05 -0700'
    - labels:
        method:
        status_code:
        path:
    - metrics:
        nginx_response_size_bytes:
          type: Counter
          description: "Total bytes served in response"
          source: response_size
          config:
            action: inc
        nginx_requests_total:
          type: Counter
          description: "Total HTTP requests"
          config:
            action: inc

# Application logs (Node.js)
- job_name: nodejs
  static_configs:
    - targets:
        - localhost
      labels:
        job: nodejs
        component: application
        environment: production
        __path__: /var/log/nodejs/*.log
  pipeline_stages:
    - json:
        expressions:
          level: level
          message: message
          timestamp: timestamp
    - timestamp:
        source: timestamp
        format: RFC3339
    - labels:
        level:
    - output:
        source: message

# Database logs (MySQL)
- job_name: mysql
  static_configs:
    - targets:
        - localhost
      labels:
        job: mysql
        component: database
        environment: production
        __path__: /var/log/mysql/*.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+Z) (?P<thread_id>\\d+) (?P<level>\\w+) (?P<message>.*)'
    - timestamp:
        source: timestamp
        format: RFC3339
    - labels:
        level:
        thread_id:

# MongoDB logs
- job_name: mongodb
  static_configs:
    - targets:
        - localhost
      labels:
        job: mongodb
        component: database
        environment: production
        __path__: /var/log/mongodb/*.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\\w{3} \\w{3} \\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d+) (?P<level>\\w+) +(?P<component>\\w+) +\\[(?P<context>[^\\]]+)\\] (?P<message>.*)'
    - timestamp:
        source: timestamp
        format: 'Mon Jan _2 15:04:05.000 2006'
    - labels:
        level:
        component:
        context:

# Docker container logs
- job_name: docker
  docker_sd_configs:
    - host: unix:///var/run/docker.sock
      refresh_interval: 15s
  relabel_configs:
    - source_labels: ['__meta_docker_container_name']
      regex: '/(.*)'
      target_label: 'container'
    - source_labels: ['__meta_docker_container_image']
      target_label: 'image'
    - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
      target_label: 'service'
  pipeline_stages:
    - json:
        expressions:
          log: log
          stream: stream
          time: time
    - timestamp:
        source: time
        format: RFC3339Nano
    - labels:
        stream:
    - output:
        source: log

# Kubernetes logs (if running in K8s)
- job_name: kubernetes-pods
  kubernetes_sd_configs:
    - role: pod
  relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_health_infraops_io_monitor]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_container_name]
      action: replace
      target_label: container
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: pod
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_label_app]
      action: replace
      target_label: service
    - source_labels: [__meta_kubernetes_pod_node_name]
      action: replace
      target_label: node
    - action: replace
      source_labels: [__meta_kubernetes_namespace]
      target_label: job
    - action: replace
      replacement: /var/log/pods/*.log
      target_label: __path__
    - action: replace
      source_labels:
        - __meta_kubernetes_pod_uid
        - __meta_kubernetes_pod_container_name
      regex: (.+);(.+)
      replacement: /var/log/pods/$1/*.log
      target_label: __path__

# Security logs
- job_name: security
  static_configs:
    - targets:
        - localhost
      labels:
        job: security
        component: security
        environment: production
        __path__: /var/log/auth.log,/var/log/secure
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\\w{3} \\d{2} \\d{2}:\\d{2}:\\d{2}) (?P<hostname>\\S+) (?P<daemon>\\S+)\\[(?P<pid>\\d+)\\]:? (?P<message>.*)'
    - timestamp:
        source: timestamp
        format: 'Jan _2 15:04:05 2006'
    - labels:
        daemon:
        hostname:

# Infrastructure monitoring logs
- job_name: infrastructure
  static_configs:
    - targets:
        - localhost
      labels:
        job: infrastructure
        component: monitoring
        environment: production
        __path__: /var/log/prometheus/*.log,/var/log/grafana/*.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+Z) (?P<level>\\w+) (?P<component>\\w+) (?P<message>.*)'
    - timestamp:
        source: timestamp
        format: RFC3339
    - labels:
        level:
        component:

# Health InfraOps custom application logs
- job_name: health-infraops
  static_configs:
    - targets:
        - localhost
      labels:
        job: health-infraops
        component: automation
        environment: production
        __path__: /opt/health-infraops/logs/**/*.log
  pipeline_stages:
    - json:
        expressions:
          timestamp: timestamp
          level: level
          message: message
          component: component
          operation: operation
    - timestamp:
        source: timestamp
        format: RFC3339
    - labels:
        level:
        component:
        operation:
    - output:
        source: message

# Performance metrics extraction
- job_name: metrics
  static_configs:
    - targets:
        - localhost
      labels:
        job: metrics
        environment: production
        __path__: /var/log/metrics/*.log
  pipeline_stages:
    - regex:
        expression: '.*response_time:(?P<response_time>\\d+\\.?\\d*).*'
    - metrics:
        response_time_seconds:
          type: Histogram
          description: "Application response time in seconds"
          source: response_time
          config:
            buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1, 5]

# Health InfraOps specific relabeling
relabel_configs:
  - source_labels: [__address__]
    target_label: instance
  - source_labels: [job]
    target_label: job
  - replacement: health-infraops
    target_label: cluster

# Health InfraOps performance tuning
limit_config:
  read_rate: 50
  read_burst: 100
  write_rate: 10
  write_burst: 25