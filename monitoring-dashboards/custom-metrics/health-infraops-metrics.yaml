# Health-InfraOps Alertmanager Configuration
# Alert routing and notification configuration

global:
  smtp_smarthost: 'smtp.infokes.co.id:587'
  smtp_from: 'alertmanager@infokes.co.id'
  smtp_auth_username: 'alertmanager'
  smtp_auth_password: '${SMTP_PASSWORD}'
  
  slack_api_url: 'https://hooks.slack.com/services/${SLACK_WEBHOOK}'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'health-infraops-slack'
  
  routes:
    - match:
        severity: critical
      receiver: 'health-infraops-pagerduty'
      group_wait: 10s
      repeat_interval: 5m
      
    - match:
        category: database
      receiver: 'health-infraops-dba-team'
      group_wait: 10s
      repeat_interval: 15m
      
    - match:
        category: security
      receiver: 'health-infraops-security-team'
      group_wait: 5s
      repeat_interval: 5m
      
    - match:
        environment: production
        severity: critical
      receiver: 'health-infraops-ops-team'
      repeat_interval: 5m
      
    - match:
        team: infrastructure
      receiver: 'health-infraops-infra-team'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']
    
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['instance']

receivers:
  - name: 'health-infraops-slack'
    slack_configs:
      - channel: '#health-infraops-alerts'
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'
        icon_emoji: ':hospital:'
        username: 'Health-InfraOps Alertmanager'
        send_resolved: true
        actions:
          - type: button
            text: 'Runbook :book:'
            url: 'https://runbooks.infokes.co.id/{{ .GroupLabels.alertname }}'
          - type: button
            text: 'Dashboard :bar_chart:'
            url: 'https://grafana.infokes.co.id/dashboard/db/health-infraops-overview'
        footer: 'Health InfraOps Monitoring System'

  - name: 'health-infraops-pagerduty'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_KEY}'
        description: '{{ .GroupLabels.alertname }} - {{ .CommonAnnotations.summary }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          summary: '{{ .CommonAnnotations.summary }}'
          description: '{{ .CommonAnnotations.description }}'
          impact: '{{ .CommonAnnotations.impact }}'
          action: '{{ .CommonAnnotations.action }}'

  - name: 'health-infraops-dba-team'
    email_configs:
      - to: 'dba-team@infokes.co.id'
        subject: '[Health-InfraOps] Database Alert: {{ .GroupLabels.alertname }}'
        body: |
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ .CommonAnnotations.summary }}
          Description: {{ .CommonAnnotations.description }}
          Impact: {{ .CommonAnnotations.impact }}
          Action Required: {{ .CommonAnnotations.action }}
          
          Firing alerts:
          {{ range .Alerts }}
            - Instance: {{ .Labels.instance }}
              Severity: {{ .Labels.severity }}
              Started: {{ .StartsAt }}
          {{ end }}
    slack_configs:
      - channel: '#dba-team-alerts'
        send_resolved: true

  - name: 'health-infraops-security-team'
    email_configs:
      - to: 'security-team@infokes.co.id'
        subject: '[SECURITY] Health-InfraOps Security Alert: {{ .GroupLabels.alertname }}'
        headers:
          priority: 'high'
          sensitivity: 'company-confidential'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SECURITY_KEY}'

  - name: 'health-infraops-ops-team'
    slack_configs:
      - channel: '#ops-critical-alerts'
        title: 'ðŸš¨ PRODUCTION CRITICAL ALERT ðŸš¨'
        text: '{{ template "slack.default.text" . }}'
        send_resolved: true
    pagerduty_configs:
      - service_key: '${PAGERDUTY_OPS_KEY}'
    webhook_configs:
      - url: 'http://ops-portal:9090/api/alerts'
        send_resolved: true

  - name: 'health-infraops-infra-team'
    slack_configs:
      - channel: '#infrastructure-team'
        send_resolved: true
    email_configs:
      - to: 'infrastructure@infokes.co.id'

  - name: 'null'  # For testing or disabling alerts

templates:
  - '/etc/alertmanager/templates/*.tmpl'