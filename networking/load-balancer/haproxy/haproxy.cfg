# Health-InfraOps HAProxy Configuration
# Infokes Healthcare System Load Balancer

global
    daemon
    maxconn 4000
    user haproxy
    group haproxy
    log 10.0.40.41:514 local0 info
    stats socket /var/run/haproxy/admin.sock mode 660 level admin
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 15s
    timeout queue 30s
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor
    retries 3
    balance roundrobin

# ============ FRONTEND CONFIGURATION ============

# HTTP to HTTPS Redirect
frontend http_frontend
    bind *:80
    mode http
    option httpclose
    
    # Redirect all HTTP traffic to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Health check endpoint
    acl health_check path /health
    monitor-uri /health
    
    # Logging
    capture request header Host len 32
    capture request header User-Agent len 64
    capture request header X-Forwarded-For len 15

# Main HTTPS Frontend
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/infokes.co.id.pem alpn h2,http/1.1
    mode http
    option httpclose
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options DENY
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # ACLs for routing
    acl is_api path_beg /api/
    acl is_static path_beg /static/ /media/
    acl is_health path /health
    
    # Backend routing
    use_backend api_servers if is_api
    use_backend static_servers if is_static
    use_backend app_servers if !is_api !is_static !is_health
    
    # Health check
    monitor-uri /health
    
    # Logging
    capture request header Host len 32
    capture request header User-Agent len 64
    capture request header X-Forwarded-For len 15

# ============ BACKEND CONFIGURATION ============

# Application Servers Backend
backend app_servers
    mode http
    balance leastconn
    option httpchk GET /health
    http-check expect status 200
    cookie SERVERID insert indirect nocache
    
    # Server definitions
    server app-01 10.0.10.11:3000 check cookie app01 inter 10s fall 3 rise 2 weight 1
    server app-02 10.0.10.12:3000 check cookie app02 inter 10s fall 3 rise 2 weight 1
    server app-03 10.0.10.13:3000 check cookie app03 inter 10s fall 3 rise 2 weight 1
    server app-04 10.0.10.14:3000 check cookie app04 inter 10s fall 3 rise 2 weight 1
    
    # Health check settings
    default-server check maxconn 100
    
    # Error handling
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 500 /etc/haproxy/errors/500.http
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css application/json

# API Servers Backend
backend api_servers
    mode http
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    
    # Server definitions
    server api-01 10.0.10.15:8000 check inter 10s fall 3 rise 2
    server api-02 10.0.10.16:8000 check inter 10s fall 3 rise 2
    server api-03 10.0.10.17:8000 check inter 10s fall 3 rise 2
    server api-04 10.0.10.18:8000 check inter 10s fall 3 rise 2
    
    # API-specific timeouts
    timeout server 30s
    timeout connect 5s
    
    # Rate limiting (basic)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # CORS headers for API
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"

# Static Content Backend
backend static_servers
    mode http
    balance source
    option httpchk GET /health
    
    # Server definitions
    server static-01 10.0.10.19:80 check inter 30s fall 2 rise 1
    server static-02 10.0.10.20:80 check inter 30s fall 2 rise 1
    
    # Static file caching headers
    http-response set-header Cache-Control "public, max-age=31536000, immutable" if { path_beg /static/ }
    http-response set-header Cache-Control "public, max-age=15552000" if { path_beg /media/ }
    
    # Compression for static content
    compression algo gzip
    compression type text/css application/javascript image/svg+xml

# ============ MONITORING & STATISTICS ============

# HAProxy Statistics
listen stats
    bind *:1936
    mode http
    stats enable
    stats hide-version
    stats realm HAProxy\ Statistics
    stats uri /haproxy?stats
    stats refresh 30s
    stats show-legends
    stats show-node
    
    # Authentication
    stats auth admin:HealthInfraOps2023!
    
    # ACL for monitoring network only
    acl monitoring_network src 10.0.40.0/24
    http-request allow if monitoring_network
    http-request deny

# ============ HEALTH CHECKS ============

# Global health check settings
backend health_checks
    mode http
    option httpchk
    
    # Application health check
    server health_check 127.0.0.1:1 check inter 10s fall 2 rise 1

# ============ ERROR FILES ============

# Custom error pages
backend error_pages
    mode http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 404 /etc/haproxy/errors/404.http