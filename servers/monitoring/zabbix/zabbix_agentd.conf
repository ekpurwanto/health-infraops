# Health-InfraOps Zabbix Agent Configuration

# Basic parameters
PidFile=/var/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=10
DebugLevel=3
EnableRemoteCommands=1
LogRemoteCommands=1

# Server configuration
Server=10.0.40.41
ServerActive=10.0.40.41
Hostname=Health-InfraOps-Node

# Network configuration
ListenPort=10050
ListenIP=0.0.0.0
SourceIP=

# Timeout configuration
Timeout=30
AllowRoot=0
User=zabbix

# TLS configuration
TLSConnect=unencrypted
TLSAccept=unencrypted

# Performance monitoring
EnablePersistentBuffer=1
PersistentBufferPeriod=1h
PersistentBufferSize=128M

# Custom checks
Include=/etc/zabbix/zabbix_agentd.d/*.conf

# User parameters
UserParameter=system.uptime,cat /proc/uptime | awk '{print $1}'
UserParameter=system.hostname,hostname
UserParameter=system.cpu.load,cat /proc/loadavg | awk '{print $1","$2","$3}'
UserParameter=system.cpu.util,mpstat 1 1 | awk '/Average/ {print 100 - $12}'
UserParameter=system.memory.total,free | awk '/Mem:/ {print $2}'
UserParameter=system.memory.used,free | awk '/Mem:/ {print $3}'
UserParameter=system.memory.free,free | awk '/Mem:/ {print $4}'
UserParameter=system.memory.available,free | awk '/Mem:/ {print $7}'
UserParameter=system.memory.pused,free | awk '/Mem:/ {printf "%.2f", $3/$2*100}'
UserParameter=system.memory.pavailable,free | awk '/Mem:/ {printf "%.2f", $7/$2*100}'
UserParameter=system.swap.total,free | awk '/Swap:/ {print $2}'
UserParameter=system.swap.used,free | awk '/Swap:/ {print $3}'
UserParameter=system.swap.free,free | awk '/Swap:/ {print $4}'
UserParameter=system.swap.pused,free | awk '/Swap:/ {printf "%.2f", $3/$2*100}'

# Disk monitoring
UserParameter=system.disk.total[*],df -B1 | awk '/$1/ {print $2}'
UserParameter=system.disk.used[*],df -B1 | awk '/$1/ {print $3}'
UserParameter=system.disk.free[*],df -B1 | awk '/$1/ {print $4}'
UserParameter=system.disk.pused[*],df | awk '/$1/ {printf "%.2f", $3/$2*100}'

# Network monitoring
UserParameter=system.net.bytes.recv[*],cat /proc/net/dev | awk '/$1:/ {print $2}'
UserParameter=system.net.bytes.sent[*],cat /proc/net/dev | awk '/$1:/ {print $10}'
UserParameter=system.net.packets.recv[*],cat /proc/net/dev | awk '/$1:/ {print $3}'
UserParameter=system.net.packets.sent[*],cat /proc/net/dev | awk '/$1:/ {print $11}'

# Process monitoring
UserParameter=system.proc.num[*],ps -eLf | grep -c "$1"
UserParameter=system.proc.mem[*],ps -eo pid,pmem,comm | grep "$1" | awk '{sum+=$2} END {print sum}'
UserParameter=system.proc.cpu[*],ps -eo pid,pcpu,comm | grep "$1" | awk '{sum+=$2} END {print sum}'

# Service monitoring
UserParameter=service.status[*],systemctl is-active $1
UserParameter=service.restart,echo 1

# Custom application checks
UserParameter=infokes.app.health,curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health
UserParameter=infokes.app.uptime,ps -p $(pgrep -f "node server.js") -o etimes= 2>/dev/null || echo 0
UserParameter=infokes.db.connections,mysql -h localhost -u monitor -p'monitor_password_123' -e "SHOW STATUS LIKE 'Threads_connected'" 2>/dev/null | tail -1 | awk '{print $2}'

# Docker monitoring
UserParameter=docker.containers.running,docker ps -q | wc -l
UserParameter=docker.containers.total,docker ps -a -q | wc -l
UserParameter=docker.images.total,docker images -q | wc -l

# SSL certificate monitoring
UserParameter=ssl.cert.expiry[*],echo | openssl s_client -connect $1 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2

# Custom script directory
Include=/etc/zabbix/zabbix_agentd.d/scripts/